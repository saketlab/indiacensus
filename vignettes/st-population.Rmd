---
title: "Scheduled Tribe population distribution"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Scheduled Tribe population distribution}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 10,
  fig.height = 8,
  dpi = 150,
  warning = FALSE,
  message = FALSE
)
```

This vignette demonstrates how to visualize Scheduled Tribe (ST) populations across Indian districts.

## Load data

```{r load-packages}
library(indiacensus)
library(dplyr)
```

```{r load-data}
data(census_1971)
data(census_2011_pca)

census_1971 |>
  filter(geography == "district") |>
  select(state, name, population_total, st_population_total) |>
  mutate(st_pct = round(100 * st_population_total / population_total, 1)) |>
  arrange(desc(st_pct)) |>
  head(10)
```

## Prepare data

```{r prepare-data}
st_1971 <- census_1971 |>
  filter(geography == "district") |>
  mutate(st_pct = 100 * st_population_total / population_total, year = 1971L) |>
  attach_geometry(1971)

st_2011 <- census_2011_pca |>
  mutate(st_pct = 100 * st_population / population_total, year = 2011L) |>
  attach_geometry(2011)

cat("1971: Districts with ST data:", sum(!is.na(st_1971$st_pct)), "of", nrow(st_1971), "\n")
cat("2011: Districts with >50% ST:", sum(st_2011$st_pct > 50, na.rm = TRUE), "\n")
```

## Map of 2011 ST population

```{r single-map, fig.height=7}
plot_map(
  st_2011,
  fill_var = "st_pct",
  title = "Scheduled Tribe Population (%)",
  subtitle = "2011 Census",
  legend_title = "ST %",
  palette = "reds",
  show_state_boundaries = TRUE
)
```

## Comparing 1971 and 2011

```{r compare-maps, fig.height=6, fig.width=11}
compare_maps(
  list("1971" = st_1971, "2011" = st_2011),
  fill_var = "st_pct",
  title = "Scheduled Tribe Population (%) by District",
  palette = "reds",
  show_state_boundaries = TRUE,
  ncol = 2
)
```

## State-level analysis

```{r state-analysis}
state_st_2011 <- census_2011_pca |>
  group_by(state_name) |>
  summarise(
    total_pop = sum(population_total, na.rm = TRUE),
    st_pop = sum(st_population, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(st_pct = 100 * st_pop / total_pop) |>
  arrange(desc(st_pct))

state_st_2011 |>
  head(10) |>
  mutate(st_pct = round(st_pct, 1), st_pop = scales::comma(st_pop)) |>
  knitr::kable(col.names = c("State", "Total Pop", "ST Pop", "ST %"))
```

## High ST concentration districts

```{r high-st-districts}
census_2011_pca |>
  mutate(st_pct = 100 * st_population / population_total) |>
  filter(st_pct > 80) |>
  select(state_name, name, st_pct) |>
  arrange(desc(st_pct)) |>
  mutate(st_pct = round(st_pct, 1)) |>
  knitr::kable(col.names = c("State", "District", "ST %"))
```
